<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Planner</title>
    <script src="imports/react.js"></script>
    <script src="imports/react-dom.js"></script>
    <script src="imports/babel.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script async defer src="https://apis.google.com/js/api.js" onload="onGapiLoad()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="onGisLoad()"></script>
</head>
<body>
    <div id="root"></div>
    <script src="utils.js"></script>
    <script>
        var __gapiReady = false, __gisReady = false;
        var __gapiCbs = [], __gisCbs = [];
        function onGapiLoad() {
            gapi.load('client', function() {
                gapi.client.init({}).then(function() {
                    return gapi.client.load('https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest');
                }).then(function() {
                    __gapiReady = true;
                    __gapiCbs.forEach(function(cb) { cb(); });
                    __gapiCbs = [];
                });
            });
        }
        function onGisLoad() {
            __gisReady = true;
            __gisCbs.forEach(function(cb) { cb(); });
            __gisCbs = [];
        }
    </script>

    <script type="text/babel">
        /* ───────────────── Compact Task Card ──────────────── */
        function TaskCard({ task, projects, gcalEventMap, onComplete, onEdit, onDelete, onUpdateNotes, compact }) {
            const [expanded, setExpanded] = React.useState(false);
            const [editingNotes, setEditingNotes] = React.useState(false);
            const [localNotes, setLocalNotes] = React.useState(task.notes || '');
            const notesRef = React.useRef(null);
            const proj = projects[task.project || 'other'] || projects.other;
            const color = proj.color;

            // Keep local notes in sync if task changes externally
            React.useEffect(() => { setLocalNotes(task.notes || ''); }, [task.notes]);

            const toggle = (e) => {
                if (e.target.closest('.tcard-actions')) return;
                if (e.target.closest('.tcard-detail-notes')) return;
                setExpanded(prev => !prev);
            };

            const startNotesEdit = (e) => {
                e.stopPropagation();
                setEditingNotes(true);
                setTimeout(() => { if (notesRef.current) notesRef.current.focus(); }, 50);
            };

            const saveNotes = () => {
                setEditingNotes(false);
                if (localNotes !== (task.notes || '') && onUpdateNotes) {
                    onUpdateNotes(task.id, localNotes);
                }
            };

            return (
                <div id={'task-' + task.id}
                    className={'tcard slide-in' + (compact ? ' tcard-compact' : '') + (expanded ? ' tcard-expanded' : '')}
                    style={{ borderLeftColor: color, '--proj-color': color }}
                    onClick={toggle}>
                    <div className="tcard-body">
                        <div className="tcard-header">
                            <span className="tcard-name">{task.name}</span>
                            <span className="tcard-score">{calculatePriority(task)}</span>
                        </div>
                        <div className="tcard-meta">
                            <span className="tcard-project" style={{ backgroundColor: color }}>{proj.name}</span>
                            {task.deadline && <span className="tcard-deadline">Due {task.deadline.includes('T') ? new Date(task.deadline).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }) : new Date(task.deadline + 'T00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>}
                            {gcalEventMap[task.id] && <span className="tcard-synced">synced</span>}
                        </div>

                        {/* Collapsed: truncated notes */}
                        {!expanded && task.notes && (
                            <div className="tcard-notes">{task.notes.length > 60 ? task.notes.slice(0, 60) + '...' : task.notes}</div>
                        )}

                        {/* Collapsed: compact stats */}
                        {!expanded && (
                            <div className="tcard-stats">
                                <span>Imp {task.importance}</span>
                                <span>Len {task.length}</span>
                                <span>Diff {task.difficulty}</span>
                                <span>{getDaysOld(task.createdAt)}d old</span>
                            </div>
                        )}

                        {/* Expanded: full details */}
                        {expanded && (
                            <div className="tcard-detail">
                                <div className="tcard-detail-grid">
                                    <div className="tcard-detail-item">
                                        <span className="tcard-detail-label">Importance</span>
                                        <span className="tcard-detail-value">{task.importance}/5</span>
                                    </div>
                                    <div className="tcard-detail-item">
                                        <span className="tcard-detail-label">Length</span>
                                        <span className="tcard-detail-value">{task.length}/5</span>
                                    </div>
                                    <div className="tcard-detail-item">
                                        <span className="tcard-detail-label">Difficulty</span>
                                        <span className="tcard-detail-value">{task.difficulty}/5</span>
                                    </div>
                                </div>
                                <div className="tcard-detail-dates">
                                    <span>Added {formatDate(task.createdAt)} ({getDaysOld(task.createdAt)} days ago)</span>
                                    {task.deadline && <span>Deadline: {task.deadline.includes('T') ? new Date(task.deadline).toLocaleString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' }) : new Date(task.deadline + 'T00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' })}</span>}
                                </div>
                                <div className="tcard-detail-notes" onClick={e => e.stopPropagation()}>
                                    <div className="tcard-detail-notes-label">Notes</div>
                                    {editingNotes ? (
                                        <textarea
                                            ref={notesRef}
                                            className="tcard-notes-textarea"
                                            value={localNotes}
                                            onChange={e => setLocalNotes(e.target.value)}
                                            onBlur={saveNotes}
                                            onKeyDown={e => { if (e.key === 'Escape') saveNotes(); }}
                                            placeholder="Add notes..."
                                            rows={3}
                                        />
                                    ) : (
                                        <div className="tcard-detail-notes-body tcard-notes-clickable" onClick={startNotesEdit}>
                                            {task.notes || <span className="tcard-notes-placeholder">Click to add notes...</span>}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                    <div className="tcard-actions" onClick={e => e.stopPropagation()}>
                        <button onClick={() => onComplete(task)} className="tcard-btn tcard-btn-done" title="Complete">&#10004;</button>
                        <button onClick={() => onEdit(task)} className="tcard-btn tcard-btn-edit" title="Edit">&#9998;</button>
                        <button onClick={() => onDelete(task.id)} className="tcard-btn tcard-btn-del" title="Delete">&#10006;</button>
                    </div>
                </div>
            );
        }

        /* ───────────────── Theme Definitions ───────────────── */
        const THEMES = {
            ocean:    { name: 'Ocean',    gradient: 'linear-gradient(135deg, #3b82f6, #1d4ed8)',     primary: '#2563eb', primaryLight: '#3b82f6', primaryDark: '#1d4ed8' },
            sunset:   { name: 'Sunset',   gradient: 'linear-gradient(135deg, #f97316, #dc2626)',     primary: '#ea580c', primaryLight: '#f97316', primaryDark: '#c2410c' },
            forest:   { name: 'Forest',   gradient: 'linear-gradient(135deg, #22c55e, #15803d)',     primary: '#16a34a', primaryLight: '#22c55e', primaryDark: '#15803d' },
            lavender: { name: 'Lavender', gradient: 'linear-gradient(135deg, #a78bfa, #7c3aed)',     primary: '#8b5cf6', primaryLight: '#a78bfa', primaryDark: '#7c3aed' },
            midnight: { name: 'Midnight', gradient: 'linear-gradient(135deg, #6366f1, #312e81)',     primary: '#4f46e5', primaryLight: '#6366f1', primaryDark: '#3730a3' },
            rose:     { name: 'Rose',     gradient: 'linear-gradient(135deg, #fb7185, #be123c)',     primary: '#e11d48', primaryLight: '#fb7185', primaryDark: '#be123c' },
            teal:     { name: 'Teal',     gradient: 'linear-gradient(135deg, #2dd4bf, #0d9488)',     primary: '#14b8a6', primaryLight: '#2dd4bf', primaryDark: '#0d9488' },
            slate:    { name: 'Slate',    gradient: 'linear-gradient(135deg, #64748b, #334155)',     primary: '#475569', primaryLight: '#64748b', primaryDark: '#334155' },
            amber:    { name: 'Amber',    gradient: 'linear-gradient(135deg, #fbbf24, #d97706)',     primary: '#d97706', primaryLight: '#fbbf24', primaryDark: '#b45309' },
            cyber:    { name: 'Cyber',    gradient: 'linear-gradient(135deg, #06b6d4, #6366f1)',     primary: '#0891b2', primaryLight: '#06b6d4', primaryDark: '#6366f1' },
        };

        /* ───────────────── Main App ───────────────────────── */
        function TaskMatrix() {
            // ─── Core State ─────────────────────────────
            const [tasks, setTasks] = React.useState(() => {
                const s = localStorage.getItem('tasks');
                return s ? JSON.parse(s) : [];
            });
            const [completedTasks, setCompletedTasks] = React.useState(() => {
                const s = localStorage.getItem('completedTasks');
                return s ? JSON.parse(s) : [];
            });
            const [showCompleted, setShowCompleted] = React.useState(false);
            const [currentFilter, setCurrentFilter] = React.useState('all');
            const [activeTab, setActiveTab] = React.useState('tasks');
            const [projectNotes, setProjectNotes] = React.useState(() => {
                const s = localStorage.getItem('projectNotes');
                return s ? JSON.parse(s) : { general: '' };
            });
            const [projects, setProjects] = React.useState(() => loadProjects());
            const [showAddProject, setShowAddProject] = React.useState(false);
            const [newProjectName, setNewProjectName] = React.useState('');
            const [newProjectColor, setNewProjectColor] = React.useState(PROJECT_COLORS[0]);
            const [editingTask, setEditingTask] = React.useState(null);

            // ─── Theme State ────────────────────────────
            const [theme, setTheme] = React.useState(() => localStorage.getItem('appTheme') || 'ocean');
            const [showThemePicker, setShowThemePicker] = React.useState(false);

            const currentTheme = THEMES[theme] || THEMES.ocean;

            // Apply theme CSS variables to document
            React.useEffect(() => {
                const root = document.documentElement;
                root.style.setProperty('--primary', currentTheme.primary);
                root.style.setProperty('--primary-light', currentTheme.primaryLight);
                root.style.setProperty('--primary-dark', currentTheme.primaryDark);
                localStorage.setItem('appTheme', theme);
            }, [theme]);

            // ─── Project Order State ────────────────────
            const [projectOrder, setProjectOrder] = React.useState(() => {
                const saved = localStorage.getItem('projectOrder');
                return saved ? JSON.parse(saved) : null;
            });

            React.useEffect(() => {
                if (projectOrder) localStorage.setItem('projectOrder', JSON.stringify(projectOrder));
            }, [projectOrder]);

            // Drag state for column reordering
            const [draggedCol, setDraggedCol] = React.useState(null);
            const [dragOverCol, setDragOverCol] = React.useState(null);

            // ─── Resize State ───────────────────────────
            const [notesPanelWidth, setNotesPanelWidth] = React.useState(() => {
                return parseInt(localStorage.getItem('notesPanelWidth')) || 260;
            });
            const resizingRef = React.useRef(false);
            const containerRef = React.useRef(null);

            React.useEffect(() => {
                localStorage.setItem('notesPanelWidth', notesPanelWidth);
            }, [notesPanelWidth]);

            // Resize handler
            const startResize = React.useCallback((e) => {
                e.preventDefault();
                resizingRef.current = true;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                const onMove = (ev) => {
                    if (!resizingRef.current || !containerRef.current) return;
                    const rect = containerRef.current.getBoundingClientRect();
                    const newWidth = Math.max(140, Math.min(500, rect.right - ev.clientX));
                    setNotesPanelWidth(newWidth);
                };
                const onUp = () => {
                    resizingRef.current = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                };
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            }, []);

            // ─── Search State ────────────────────────────
            const [searchQuery, setSearchQuery] = React.useState('');
            const doSearch = (e) => {
                e.preventDefault();
                const q = searchQuery.trim();
                if (q) window.open('https://www.google.com/search?q=' + encodeURIComponent(q), '_blank');
            };

            // ─── Google Calendar State ──────────────────
            const [gcalClientId, setGcalClientId] = React.useState(() => localStorage.getItem('gcalClientId') || '');
            const [gcalEmbedUrl, setGcalEmbedUrl] = React.useState(() => localStorage.getItem('gcalEmbedUrl') || '');
            const [gcalCalendarId, setGcalCalendarId] = React.useState(() => localStorage.getItem('gcalCalendarId') || 'primary');
            const [gcalSignedIn, setGcalSignedIn] = React.useState(false);
            const [gcalEventMap, setGcalEventMap] = React.useState(() => JSON.parse(localStorage.getItem('gcalEventMap') || '{}'));
            const [gcalSyncing, setGcalSyncing] = React.useState(false);
            const [gcalStatus, setGcalStatus] = React.useState('');
            const [apisLoaded, setApisLoaded] = React.useState(false);
            const [showGcalSetup, setShowGcalSetup] = React.useState(false);
            const [gcalRefreshKey, setGcalRefreshKey] = React.useState(0);
            const tokenClientRef = React.useRef(null);
            const [setupClientId, setSetupClientId] = React.useState('');
            const [setupEmbedUrl, setSetupEmbedUrl] = React.useState('');
            const [setupCalendarId, setSetupCalendarId] = React.useState('');

            // ─── Google API Init ────────────────────────
            React.useEffect(() => {
                const check = () => { if (__gapiReady && __gisReady) setApisLoaded(true); };
                if (__gapiReady && __gisReady) setApisLoaded(true);
                else { if (!__gapiReady) __gapiCbs.push(check); if (!__gisReady) __gisCbs.push(check); }
            }, []);
            React.useEffect(() => {
                if (apisLoaded && gcalClientId) {
                    tokenClientRef.current = google.accounts.oauth2.initTokenClient({
                        client_id: gcalClientId,
                        scope: 'https://www.googleapis.com/auth/calendar.events',
                        callback: (r) => { if (r.error) { setGcalStatus('Auth failed'); return; } setGcalSignedIn(true); setGcalStatus('Signed in'); },
                    });
                }
            }, [apisLoaded, gcalClientId]);

            // ─── Persistence ────────────────────────────
            React.useEffect(() => { PROJECTS = projects; saveProjects(projects); }, [projects]);
            React.useEffect(() => {
                localStorage.setItem('tasks', JSON.stringify(tasks));
                localStorage.setItem('completedTasks', JSON.stringify(completedTasks));
                localStorage.setItem('projectNotes', JSON.stringify(projectNotes));
            }, [tasks, completedTasks, projectNotes]);
            React.useEffect(() => { localStorage.setItem('gcalEventMap', JSON.stringify(gcalEventMap)); }, [gcalEventMap]);

            // ─── Google Calendar Helpers ─────────────────
            const isGcalReady = () => gcalSignedIn && gapi && gapi.client && gapi.client.getToken();
            const refreshEmbed = () => setGcalRefreshKey(k => k + 1);
            const syncOneTask = async (task) => {
                if (!isGcalReady() || !task.deadline) return null;
                const pn = (projects[task.project] || projects.other).name;
                const hasTime = task.deadline.includes('T');
                const startEnd = hasTime
                    ? { start: { dateTime: new Date(task.deadline).toISOString() }, end: { dateTime: new Date(new Date(task.deadline).getTime() + 3600000).toISOString() } }
                    : { start: { date: task.deadline }, end: { date: task.deadline } };
                const ev = { summary: '[' + pn + '] ' + task.name, description: 'Imp:' + task.importance + ' Len:' + task.length + ' Diff:' + task.difficulty + (task.notes ? '\n' + task.notes : ''), ...startEnd };
                try {
                    let r; const eid = gcalEventMap[task.id];
                    if (eid) { try { r = await gapi.client.calendar.events.update({ calendarId: gcalCalendarId, eventId: eid, resource: ev }); } catch(_) { r = await gapi.client.calendar.events.insert({ calendarId: gcalCalendarId, resource: ev }); } }
                    else { r = await gapi.client.calendar.events.insert({ calendarId: gcalCalendarId, resource: ev }); }
                    setGcalEventMap(p => ({ ...p, [task.id]: r.result.id })); return r.result.id;
                } catch(e) { return null; }
            };
            const removeOneFromGcal = async (taskId) => {
                if (!isGcalReady()) return; const eid = gcalEventMap[taskId]; if (!eid) return;
                try { await gapi.client.calendar.events.delete({ calendarId: gcalCalendarId, eventId: eid }); } catch(_){}
                setGcalEventMap(p => { const u = { ...p }; delete u[taskId]; return u; });
            };
            const syncAllTasks = async () => {
                if (!isGcalReady()) return; setGcalSyncing(true); setGcalStatus('Syncing...');
                const wd = tasks.filter(t => t.deadline); let ok = 0;
                for (const t of wd) { if (await syncOneTask(t)) ok++; }
                setGcalSyncing(false); setGcalStatus('Synced ' + ok + '/' + wd.length); refreshEmbed();
            };
            const signIn = () => { if (tokenClientRef.current) tokenClientRef.current.requestAccessToken({ prompt: 'consent' }); };
            const signOut = () => { const t = gapi.client.getToken(); if (t) { google.accounts.oauth2.revoke(t.access_token); gapi.client.setToken(null); } setGcalSignedIn(false); setGcalStatus('Signed out'); };
            const openSetup = () => { setSetupClientId(gcalClientId); setSetupEmbedUrl(gcalEmbedUrl); setSetupCalendarId(gcalCalendarId === 'primary' ? '' : gcalCalendarId); setShowGcalSetup(true); };
            const saveSetup = () => {
                const cid = setupClientId.trim(); const embed = setupEmbedUrl.trim();
                if (cid) { setGcalClientId(cid); localStorage.setItem('gcalClientId', cid); }
                if (embed) { const m = embed.match(/src="([^"]+)"/); const u = m ? m[1] : embed; setGcalEmbedUrl(u); localStorage.setItem('gcalEmbedUrl', u); } else { setGcalEmbedUrl(''); localStorage.removeItem('gcalEmbedUrl'); }
                const calId = setupCalendarId.trim(); if (calId) { setGcalCalendarId(calId); localStorage.setItem('gcalCalendarId', calId); } else { setGcalCalendarId('primary'); localStorage.setItem('gcalCalendarId', 'primary'); }
                setShowGcalSetup(false);
            };

            // ─── Project Management ─────────────────────
            const addProject = () => {
                const trimmed = newProjectName.trim(); if (!trimmed) return;
                const id = trimmed.toLowerCase().replace(/\s+/g, '-');
                if (projects[id]) { alert('Already exists.'); return; }
                setProjects(p => ({ ...p, [id]: { name: trimmed, color: newProjectColor } }));
                // Append new project to order (before 'other' if possible)
                setProjectOrder(prev => {
                    const order = prev ? [...prev] : [...rawProjectIds];
                    const otherIdx = order.indexOf('other');
                    if (otherIdx >= 0) order.splice(otherIdx, 0, id);
                    else order.push(id);
                    return order;
                });
                setNewProjectName(''); setNewProjectColor(PROJECT_COLORS[Math.floor(Math.random() * PROJECT_COLORS.length)]); setShowAddProject(false);
            };
            const deleteProject = (pid) => {
                if (pid === 'other') return;
                if (!confirm('Delete "' + projects[pid].name + '"? Tasks move to Other.')) return;
                setTasks(p => p.map(t => t.project === pid ? { ...t, project: 'other' } : t));
                setCompletedTasks(p => p.map(t => t.project === pid ? { ...t, project: 'other' } : t));
                setProjects(p => { const u = { ...p }; delete u[pid]; return u; });
                setProjectOrder(prev => prev ? prev.filter(id => id !== pid) : null);
                if (currentFilter === pid) setCurrentFilter('all');
            };

            // ─── Task CRUD ──────────────────────────────
            const completeTask = (task) => {
                const el = document.getElementById('task-' + task.id); if (el) el.classList.add('celebrate');
                setTimeout(() => {
                    setTasks(p => p.filter(t => t.id !== task.id));
                    setCompletedTasks(p => [{ ...task, completedAt: new Date().toISOString() }, ...p.slice(0, 49)]);
                    removeOneFromGcal(task.id).then(refreshEmbed);
                }, 400);
            };
            const revertTask = (task) => {
                setCompletedTasks(p => p.filter(t => t.id !== task.id));
                const r = { ...task, createdAt: new Date().toISOString() };
                setTasks(p => [...p, r]);
                if (r.deadline) syncOneTask(r).then(refreshEmbed);
            };
            const removeTask = (id) => { setTasks(p => p.filter(t => t.id !== id)); removeOneFromGcal(id).then(refreshEmbed); };
            const updateTaskNotes = (id, notes) => { setTasks(p => p.map(t => t.id === id ? { ...t, notes } : t)); };
            const removeCompletedTask = (id) => { setCompletedTasks(p => p.filter(t => t.id !== id)); };
            const startEditing = (task) => setEditingTask({ ...task });
            const saveEdit = () => {
                let saved;
                if (editingTask.id === 'new') { saved = { ...editingTask, id: Date.now(), createdAt: new Date().toISOString() }; setTasks(p => [...p, saved]); }
                else { saved = editingTask; setTasks(p => p.map(t => t.id === editingTask.id ? editingTask : t)); }
                setEditingTask(null);
                if (saved.deadline) syncOneTask(saved).then(refreshEmbed); else removeOneFromGcal(saved.id).then(refreshEmbed);
            };

            // ─── Derived Data ───────────────────────────
            const sortedAll = [...tasks].sort((a, b) => calculatePriority(b) - calculatePriority(a));
            const top4 = sortedAll.slice(0, 4);
            const rawProjectIds = Object.keys(projects);

            // Use saved order, but sync with actual projects (remove deleted, append new)
            const projectIds = React.useMemo(() => {
                if (!projectOrder) return rawProjectIds;
                const ordered = projectOrder.filter(id => rawProjectIds.includes(id));
                const missing = rawProjectIds.filter(id => !ordered.includes(id));
                return [...ordered, ...missing];
            }, [projectOrder, rawProjectIds.join(',')]);

            // Column reorder helpers
            const onColDragStart = (pid) => setDraggedCol(pid);
            const onColDragOver = (e, pid) => { e.preventDefault(); if (pid !== draggedCol) setDragOverCol(pid); };
            const onColDrop = (pid) => {
                if (!draggedCol || draggedCol === pid) { setDraggedCol(null); setDragOverCol(null); return; }
                const order = [...projectIds];
                const fromIdx = order.indexOf(draggedCol);
                const toIdx = order.indexOf(pid);
                order.splice(fromIdx, 1);
                order.splice(toIdx, 0, draggedCol);
                setProjectOrder(order);
                setDraggedCol(null);
                setDragOverCol(null);
            };
            const onColDragEnd = () => { setDraggedCol(null); setDragOverCol(null); };

            const getProjectTasks = (pid) => {
                return sortedAll.filter(t => {
                    if (pid === 'other') return !t.project || t.project === 'other';
                    return t.project === pid;
                });
            };

            const filteredTasks = currentFilter === 'all' ? sortedAll : sortedAll.filter(t => {
                if (currentFilter === 'other') return !t.project || t.project === 'other';
                return t.project === currentFilter;
            });
            const filteredCompleted = currentFilter === 'all' ? completedTasks : completedTasks.filter(t => t.project === currentFilter || (!t.project && currentFilter === 'other'));

            // ─── JSON IO ────────────────────────────────
            const exportToJson = () => {
                const d = { tasks, completedTasks, projects };
                const b = new Blob([JSON.stringify(d, null, 2)], { type: 'application/json' });
                const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download = 'tasks-' + new Date().toISOString().split('T')[0] + '.json'; a.click(); URL.revokeObjectURL(u);
            };
            const importFromJson = (e) => {
                const f = e.target.files[0]; if (!f) return;
                const r = new FileReader(); r.onload = (ev) => { try { const d = JSON.parse(ev.target.result); setTasks(d.tasks || []); setCompletedTasks(d.completedTasks || []); if (d.projects) setProjects(p => ({ ...p, ...d.projects, other: p.other })); } catch(_) { alert('Invalid JSON'); } }; r.readAsText(f); e.target.value = '';
            };

            const tasksWithDeadlines = tasks.filter(t => t.deadline).length;
            const syncedCount = Object.keys(gcalEventMap).filter(id => tasks.some(t => String(t.id) === id && t.deadline)).length;

            // ═════════════════════════════════════════════
            return (
                <div>
                    <div className="card">
                        {/* ── HEADER ──────────────────────────── */}
                        <div className="header-container" style={{ background: currentTheme.gradient }}>
                            <div className="header-left">
                                <h1 className="header-title">Task Manager</h1>
                            </div>
                            <div className="header-center">
                                <div className="workload-message">
                                    <div className="message-main">{analyzeWorkload(tasks).message}</div>
                                    <div className="message-advice">{analyzeWorkload(tasks).advice}</div>
                                    <div className="message-workload">{analyzeWorkload(tasks).workload}</div>
                                </div>
                                <form className="google-search-bar" onSubmit={doSearch}>
                                    <span className="search-icon">&#128269;</span>
                                    <input type="text" className="search-input" value={searchQuery}
                                        onChange={e => setSearchQuery(e.target.value)}
                                        placeholder="Search Google..." />
                                    <button type="submit" className="search-btn">Go</button>
                                </form>
                            </div>
                            <div className="header-right">
                                <button onClick={() => setShowThemePicker(!showThemePicker)} className="btn-secondary theme-toggle-btn" title="Change theme">
                                    &#9783; Theme
                                </button>
                                <button onClick={() => generateICS(tasks)} className="btn-secondary" title="Download .ics">Export .ics</button>
                                <button onClick={exportToJson} className="btn-secondary">Export JSON</button>
                                <label className="btn-secondary">Import JSON<input type="file" accept=".json" onChange={importFromJson} className="hidden" /></label>
                            </div>
                        </div>

                        {/* ── THEME PICKER ────────────────────── */}
                        {showThemePicker && (
                            <div className="theme-picker">
                                {Object.entries(THEMES).map(([id, t]) => (
                                    <button key={id}
                                        className={'theme-swatch' + (theme === id ? ' theme-active' : '')}
                                        style={{ background: t.gradient }}
                                        onClick={() => { setTheme(id); setShowThemePicker(false); }}
                                        title={t.name}>
                                        <span className="theme-swatch-label">{t.name}</span>
                                    </button>
                                ))}
                            </div>
                        )}

                        {/* ── PROJECT TABS ────────────────────── */}
                        <div className="project-tabs">
                            <button className={'project-tab ' + (currentFilter === 'all' ? 'active' : '')} onClick={() => setCurrentFilter('all')}>All</button>
                            {projectIds.map(pid => (
                                <button key={pid}
                                    className={'project-tab ' + (currentFilter === pid ? 'active' : '') + (draggedCol === pid ? ' ptab-dragging' : '') + (dragOverCol === pid ? ' ptab-drag-over' : '')}
                                    draggable
                                    onDragStart={() => onColDragStart(pid)}
                                    onDragOver={(e) => onColDragOver(e, pid)}
                                    onDrop={() => onColDrop(pid)}
                                    onDragEnd={onColDragEnd}
                                    onClick={() => setCurrentFilter(pid)}
                                    style={{ borderLeft: currentFilter !== pid ? '3px solid ' + projects[pid].color : 'none' }}>
                                    {projects[pid].name}
                                    {pid !== 'other' && <span className="project-delete-x" onClick={e => { e.stopPropagation(); deleteProject(pid); }}>&times;</span>}
                                </button>
                            ))}
                            <button className="project-tab add-project-tab" onClick={() => setShowAddProject(true)}>+ Project</button>
                        </div>

                        {/* ── VIEW TOGGLE ─────────────────────── */}
                        <div className="view-toggle">
                            <button className={'view-toggle-btn ' + (activeTab === 'tasks' ? 'active' : '')} onClick={() => setActiveTab('tasks')}>Tasks</button>
                            <button className={'view-toggle-btn ' + (activeTab === 'calendar' ? 'active' : '')} onClick={() => setActiveTab('calendar')}>Google Calendar</button>
                        </div>
                        <div className="section-divider"></div>

                        {/* ═══ TASKS VIEW ════════════════════════ */}
                        {activeTab === 'tasks' && (
                            <div className="dashboard-content">
                                {/* ── TOP PRIORITY ROW ───────────── */}
                                {top4.length > 0 && (
                                    <div className="top-priority-section">
                                        <div className="section-label">Top Priority</div>
                                        <div className="top-priority-row">
                                            {top4.map(task => (
                                                <TaskCard key={task.id} task={task} projects={projects} gcalEventMap={gcalEventMap}
                                                    onComplete={completeTask} onEdit={startEditing} onDelete={removeTask} onUpdateNotes={updateTaskNotes} compact={false} />
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* ── PROJECT COLUMNS + NOTES ────── */}
                                <div className="columns-and-notes" ref={containerRef}>
                                    <div className="project-columns-area">
                                        {currentFilter === 'all' ? (
                                            /* All: show each project as a column */
                                            <div className="project-columns">
                                                {projectIds.filter(pid => getProjectTasks(pid).length > 0).map(pid => (
                                                    <div key={pid}
                                                        className={'project-column' + (draggedCol === pid ? ' pcol-dragging' : '') + (dragOverCol === pid ? ' pcol-drag-over' : '')}
                                                        draggable
                                                        onDragStart={() => onColDragStart(pid)}
                                                        onDragOver={(e) => onColDragOver(e, pid)}
                                                        onDrop={() => onColDrop(pid)}
                                                        onDragEnd={onColDragEnd}>
                                                        <div className="pcol-header" style={{ backgroundColor: projects[pid].color }}>
                                                            <span className="pcol-drag-handle" title="Drag to reorder">&#9776;</span>
                                                            {projects[pid].name}
                                                            <span className="pcol-count">{getProjectTasks(pid).length}</span>
                                                        </div>
                                                        <div className="pcol-tasks">
                                                            {getProjectTasks(pid).map(task => (
                                                                <TaskCard key={task.id} task={task} projects={projects} gcalEventMap={gcalEventMap}
                                                                    onComplete={completeTask} onEdit={startEditing} onDelete={removeTask} onUpdateNotes={updateTaskNotes} compact={true} />
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))}
                                                {/* Add task column */}
                                                <div className="project-column add-col">
                                                    <div className="add-task-card" onClick={() => setEditingTask({
                                                        id: 'new', name: '', importance: 3, length: 3, difficulty: 3,
                                                        project: 'other', deadline: '', notes: ''
                                                    })}>
                                                        <span className="add-icon">+</span>
                                                        <span>Add Task</span>
                                                    </div>
                                                </div>
                                            </div>
                                        ) : (
                                            /* Filtered: show single project tasks as a grid */
                                            <div>
                                                <div className="section-label" style={{ color: projects[currentFilter] ? projects[currentFilter].color : undefined }}>
                                                    {(projects[currentFilter] || projects.other).name} ({filteredTasks.length})
                                                </div>
                                                <div className="filtered-grid">
                                                    <div className="add-task-card" onClick={() => setEditingTask({
                                                        id: 'new', name: '', importance: 3, length: 3, difficulty: 3,
                                                        project: currentFilter, deadline: '', notes: ''
                                                    })}>
                                                        <span className="add-icon">+</span>
                                                        <span>Add Task</span>
                                                    </div>
                                                    {filteredTasks.map(task => (
                                                        <TaskCard key={task.id} task={task} projects={projects} gcalEventMap={gcalEventMap}
                                                            onComplete={completeTask} onEdit={startEditing} onDelete={removeTask} onUpdateNotes={updateTaskNotes} compact={false} />
                                                    ))}
                                                </div>
                                            </div>
                                        )}

                                        {/* Completed */}
                                        <div style={{ marginTop: '1rem' }}>
                                            <button onClick={() => setShowCompleted(!showCompleted)} className="completed-toggle">
                                                <span>Completed ({filteredCompleted.length})</span>
                                                <span>{showCompleted ? '\u25BC' : '\u25B6'}</span>
                                            </button>
                                            {showCompleted && (
                                                <div className="completed-grid">
                                                    {filteredCompleted.map(task => {
                                                        const proj = projects[task.project || 'other'] || projects.other;
                                                        return (
                                                            <div key={task.id} className="tcard tcard-completed" style={{ borderLeftColor: proj.color }}>
                                                                <div className="tcard-body">
                                                                    <div className="tcard-name">{task.name}</div>
                                                                    <div className="tcard-meta">
                                                                        <span className="tcard-project" style={{ backgroundColor: proj.color }}>{proj.name}</span>
                                                                    </div>
                                                                    <div className="tcard-stats">
                                                                        <span>Completed {formatDate(task.completedAt)}</span>
                                                                    </div>
                                                                </div>
                                                                <div className="tcard-actions">
                                                                    <button onClick={() => revertTask(task)} className="tcard-btn tcard-btn-edit" title="Revert">&larr;</button>
                                                                    <button onClick={() => removeCompletedTask(task.id)} className="tcard-btn tcard-btn-del" title="Delete">&#10006;</button>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {/* ── RESIZE HANDLE ─────────────── */}
                                    <div className="resize-handle" onMouseDown={startResize} title="Drag to resize">
                                        <div className="resize-handle-bar"></div>
                                    </div>

                                    {/* ── NOTES SIDEBAR ──────────────── */}
                                    <div className="notes-sidebar" style={{ width: notesPanelWidth, minWidth: notesPanelWidth, maxWidth: notesPanelWidth }}>
                                        <div className="notes-sidebar-label">Notes</div>
                                        <textarea
                                            value={projectNotes[currentFilter === 'all' ? 'general' : currentFilter] || ''}
                                            onChange={(e) => {
                                                const k = currentFilter === 'all' ? 'general' : currentFilter;
                                                setProjectNotes(p => ({ ...p, [k]: e.target.value }));
                                            }}
                                            className="notes-textarea"
                                            placeholder={'Notes for ' + (currentFilter === 'all' ? 'general' : (projects[currentFilter] || projects.other).name) + '...'}
                                        />
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* ═══ GOOGLE CALENDAR VIEW ══════════════ */}
                        {activeTab === 'calendar' && (
                            <div className="gcal-view">
                                <div className="gcal-control-bar">
                                    {!gcalClientId ? (
                                        <div className="gcal-bar-row"><span className="gcal-bar-label">Google Calendar not connected</span><button className="btn btn-primary" onClick={openSetup}>Set Up Sync</button></div>
                                    ) : !gcalSignedIn ? (
                                        <div className="gcal-bar-row"><span className="gcal-bar-label">Sign in to sync tasks</span><div className="gcal-bar-actions"><button className="btn btn-primary" onClick={signIn} disabled={!apisLoaded}>{apisLoaded ? 'Sign in with Google' : 'Loading...'}</button><button className="gcal-settings-btn" onClick={openSetup}>&#9881;</button></div></div>
                                    ) : (
                                        <div className="gcal-bar-row"><div className="gcal-bar-info"><span className="gcal-connected-dot"></span><span className="gcal-bar-label">Connected</span>{gcalStatus && <span className="gcal-bar-status">{gcalStatus}</span>}<span className="gcal-bar-count">{syncedCount}/{tasksWithDeadlines} synced</span></div><div className="gcal-bar-actions"><button className="btn btn-primary" onClick={syncAllTasks} disabled={gcalSyncing}>{gcalSyncing ? 'Syncing...' : 'Sync All'}</button><button className="btn" onClick={signOut}>Sign Out</button><button className="gcal-settings-btn" onClick={openSetup}>&#9881;</button></div></div>
                                    )}
                                </div>
                                {gcalEmbedUrl ? (
                                    <div className="gcal-embed-wrapper"><iframe key={gcalRefreshKey} src={gcalEmbedUrl + (gcalEmbedUrl.includes('?') ? '&' : '?') + '_r=' + gcalRefreshKey} className="gcal-iframe" frameBorder="0" scrolling="no" title="Google Calendar"></iframe></div>
                                ) : (
                                    <div className="gcal-empty-state"><div className="gcal-empty-icon">&#128197;</div><h3>No Calendar URL</h3><p>Add your Google Calendar embed URL.</p><button className="btn btn-primary" style={{ marginTop: '1rem' }} onClick={openSetup}>Add URL</button></div>
                                )}
                                <div className="gcal-hint"><strong>How sync works:</strong> Tasks with deadlines become Google Calendar events automatically.</div>
                            </div>
                        )}

                        {/* ═══ MATTERMOST VIEW ═════════════════ */}
                        {/* ═══ EDIT / ADD TASK MODAL ═════════════ */}
                        {editingTask && (
                            <div className="edit-overlay" onClick={() => setEditingTask(null)}>
                                <div className="edit-modal" onClick={e => e.stopPropagation()}>
                                    <h3 className="modal-title">{editingTask.id === 'new' ? 'New Task' : 'Edit: ' + editingTask.name}</h3>
                                    <input type="text" value={editingTask.name} onChange={e => setEditingTask({ ...editingTask, name: e.target.value })}
                                        className="input" placeholder="Task name..." autoFocus />
                                    <div className="grid">
                                        {['Importance', 'Length', 'Difficulty'].map(type => (
                                            <div key={type} className="slider-container">
                                                <label className="slider-label">{type}: {editingTask[type.toLowerCase()]}</label>
                                                <input type="range" min="1" max="5" value={editingTask[type.toLowerCase()]}
                                                    onChange={e => setEditingTask({ ...editingTask, [type.toLowerCase()]: parseInt(e.target.value) })}
                                                    className="slider" style={{ '--slider-value': ((editingTask[type.toLowerCase()] - 1) * 25) + '%' }} />
                                            </div>
                                        ))}
                                    </div>
                                    <div className="modal-row-2">
                                        <div className="slider-container">
                                            <label className="slider-label">Deadline</label>
                                            <input type="datetime-local" value={editingTask.deadline || ''} onChange={e => setEditingTask({ ...editingTask, deadline: e.target.value || null })} className="input" />
                                        </div>
                                        <div className="slider-container">
                                            <label className="slider-label">Project</label>
                                            <select value={editingTask.project || 'other'} onChange={e => setEditingTask({ ...editingTask, project: e.target.value })} className="input">
                                                {projectIds.map(pid => <option key={pid} value={pid}>{projects[pid].name}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    {/* ── Task Notes ─────────── */}
                                    <div className="slider-container" style={{ marginTop: '0.5rem' }}>
                                        <label className="slider-label">Notes</label>
                                        <textarea value={editingTask.notes || ''} onChange={e => setEditingTask({ ...editingTask, notes: e.target.value })}
                                            className="input task-notes-input" placeholder="Add notes to this task..." rows={3} />
                                    </div>
                                    <div className="modal-actions">
                                        <button onClick={() => setEditingTask(null)} className="btn">Cancel</button>
                                        <button onClick={saveEdit} className="btn btn-primary">{editingTask.id === 'new' ? 'Add Task' : 'Save'}</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* ═══ ADD PROJECT MODAL ═════════════════ */}
                        {showAddProject && (
                            <div className="edit-overlay" onClick={() => setShowAddProject(false)}>
                                <div className="edit-modal add-project-modal" onClick={e => e.stopPropagation()}>
                                    <h3 className="modal-title">Add Project</h3>
                                    <input type="text" value={newProjectName} onChange={e => setNewProjectName(e.target.value)} className="input" placeholder="Project name..." autoFocus onKeyDown={e => e.key === 'Enter' && addProject()} />
                                    <div className="color-picker-section">
                                        <label className="slider-label" style={{ marginBottom: '0.5rem' }}>Color:</label>
                                        <div className="color-grid">
                                            {PROJECT_COLORS.map(c => <button key={c} className={'color-swatch ' + (newProjectColor === c ? 'selected' : '')} style={{ backgroundColor: c }} onClick={() => setNewProjectColor(c)} />)}
                                        </div>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginTop: '0.75rem' }}>
                                            <label className="slider-label">Custom:</label>
                                            <input type="color" value={newProjectColor} onChange={e => setNewProjectColor(e.target.value)} className="color-input-native" />
                                        </div>
                                    </div>
                                    <div className="project-preview"><span>Preview: </span><span className="tcard-project" style={{ backgroundColor: newProjectColor }}>{newProjectName || 'Name'}</span></div>
                                    <div className="modal-actions"><button onClick={() => setShowAddProject(false)} className="btn">Cancel</button><button onClick={addProject} className="btn btn-primary">Add</button></div>
                                </div>
                            </div>
                        )}

                        {/* ═══ GCAL SETUP MODAL ══════════════════ */}
                        {showGcalSetup && (
                            <div className="edit-overlay" onClick={() => setShowGcalSetup(false)}>
                                <div className="edit-modal gcal-setup-modal" onClick={e => e.stopPropagation()}>
                                    <h3 className="modal-title">Google Calendar Setup</h3>
                                    <div className="gcal-setup-section">
                                        <h4 className="gcal-setup-heading">1. Embed URL <span className="gcal-optional">(view calendar)</span></h4>
                                        <div className="gcal-instructions"><ol><li>Open <a href="https://calendar.google.com/calendar/r/settings" target="_blank">Calendar Settings</a></li><li>Select calendar &rarr; Integrate calendar</li><li>Copy embed code or URL</li></ol></div>
                                        <textarea value={setupEmbedUrl} onChange={e => setSetupEmbedUrl(e.target.value)} className="input" placeholder="Paste embed URL or iframe..." rows={2} style={{ resize: 'vertical', fontFamily: 'monospace', fontSize: '0.85rem' }} />
                                    </div>
                                    <div className="gcal-setup-section">
                                        <h4 className="gcal-setup-heading">2. Calendar ID <span className="gcal-optional">(which calendar)</span></h4>
                                        <div className="gcal-instructions"><ol><li>In Calendar Settings, select the target calendar</li><li>Copy the <strong>Calendar ID</strong></li></ol></div>
                                        <input type="text" value={setupCalendarId} onChange={e => setSetupCalendarId(e.target.value)} className="input" placeholder="Leave blank for primary" style={{ fontFamily: 'monospace', fontSize: '0.85rem' }} />
                                    </div>
                                    <div className="gcal-setup-section">
                                        <h4 className="gcal-setup-heading">3. Client ID <span className="gcal-optional">(API access)</span></h4>
                                        <div className="gcal-instructions"><ol><li>Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Google Cloud Console</a></li><li>Enable Calendar API, create OAuth 2.0 Client ID</li><li>Add your site URL to Authorized JS origins</li></ol></div>
                                        <input type="text" value={setupClientId} onChange={e => setSetupClientId(e.target.value)} className="input" placeholder="123456-xxx.apps.googleusercontent.com" style={{ fontFamily: 'monospace', fontSize: '0.85rem' }} />
                                    </div>
                                    <div className="modal-actions"><button onClick={() => setShowGcalSetup(false)} className="btn">Cancel</button><button onClick={saveSetup} className="btn btn-primary">Save</button></div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }
        ReactDOM.render(<TaskMatrix />, document.getElementById('root'));
    </script>
</body>
</html>
